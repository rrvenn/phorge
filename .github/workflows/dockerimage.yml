name: Monitor External Repo and Build Docker Image

on:
  schedule:
    - cron: "0 0 * * *"   # Every night at midnight UTC
  workflow_dispatch: {}    # Allow manual runs

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Check out THIS repository
      # --------------------------
      - name: Checkout this repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Load previously stored commit hash
      # --------------------------
      - name: Read previous external hash
        id: get_prev_hash
        run: |
          if [ -f .external_repo_hash ]; then
            echo "PREV_HASH=$(cat .external_repo_hash)" >> $GITHUB_ENV
          else
            echo "PREV_HASH=none" >> $GITHUB_ENV
          fi

      # --------------------------
      # 3. Get the latest commit hash from phorgeit/phorge
      # --------------------------
      - name: Get latest hash from external repo
        id: get_latest_hash
        run: |
          LATEST_HASH=$(git ls-remote https://github.com/phorgeit/phorge.git HEAD | awk '{print $1}')
          echo "LATEST_HASH=$LATEST_HASH" >> $GITHUB_ENV
          echo "Latest external hash: $LATEST_HASH"

      # --------------------------
      # 4. Compare hashes
      # --------------------------
      - name: Compare hashes
        id: compare
        run: |
          if [ "$PREV_HASH" = "$LATEST_HASH" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # --------------------------
      # 5. Stop if no new commits
      # --------------------------
      - name: Stop if unchanged
        if: steps.compare.outputs.changed == 'false'
        run: echo "No changes in external repo. Exiting."

      # --------------------------
      # 6. Build and push Docker image
      # --------------------------
      - name: Login to Docker Hub
        if: steps.compare.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.compare.outputs.changed == 'true'
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/phorge"
          TAG="${LATEST_HASH}"

          echo "Building Docker image with tag: $TAG"
          # Build the image from the repository's Dockerfile
          docker build -t "${IMAGE_NAME}:${TAG}" .

          # Tag the built image as latest and push both tags
          docker tag "${IMAGE_NAME}:${TAG}" "${IMAGE_NAME}:latest"
          docker push "${IMAGE_NAME}:${TAG}" --all-tags

      # --------------------------
      # 7. Save new commit hash
      # --------------------------
      - name: Save new hash
        if: steps.compare.outputs.changed == 'true'
        run: |
          echo "$LATEST_HASH" > .external_repo_hash

      - name: Commit updated hash file
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update external repo hash to ${{ env.LATEST_HASH }}"
